name: Deploy to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploying to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
    - name: Conectarse por SSH y Desplegar
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # 1. Entrar a la carpeta
          # Aseg√∫rate de que '/root/city' es la ruta exacta que te da el comando 'pwd'
          cd /root/CityAirLogs_Infra
          
          # 2. FORZAR ACTUALIZACI√ìN (La soluci√≥n al problema)
          echo "üì• Forzando sincronizaci√≥n con GitHub..."
          # Descarga la info m√°s reciente sin fusionar
          git fetch origin main
          # Obliga al c√≥digo local a ser id√©ntico al de GitHub (sobrescribe cambios locales)
          git reset --hard origin/main
          
          # 3. Reconstrucci√≥n Limpia
          echo "üê≥ Reiniciando contenedores..."
          # Bajamos primero para asegurar que no queden procesos zombies
          docker compose down
          docker compose up -d --build
          
          # Esperamos un poco m√°s para asegurar que MySQL est√© listo antes de migrar
          sleep 10
          
          echo "üóÑÔ∏è Mantenimiento Django..."
          # --- TUS COMANDOS DE MIGRACI√ìN ORIGINALES (INTACTOS) ---
          docker compose exec -T web python manage.py makemigrations core
          docker compose exec -T web python manage.py migrate core
          docker compose exec -T web python manage.py migrate
          docker compose exec -T web python manage.py collectstatic --noinput
          # -------------------------------------------------------
          
          docker system prune -f
          echo "‚úÖ Despliegue completado!"