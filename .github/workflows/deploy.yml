name: Deploy to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploying to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
    - name: Conectarse por SSH y Desplegar
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # 1. Ir a la carpeta del proyecto
          # Â¡IMPORTANTE!: AsegÃºrate de que esta ruta sea EXACTA a donde clonaste el repo en tu VM
          cd /root/CityAir-Logs 
          
          echo "ğŸš€ Iniciando despliegue..."
          
          # 2. Forzar actualizaciÃ³n del cÃ³digo (Modo 'Destructor')
          # Esto evita conflictos si modificaste archivos manualmente en la VM
          echo "ğŸ“¥ Descargando cambios desde GitHub..."
          git fetch origin main
          git reset --hard origin/main
          
          # 3. Reconstruir los contenedores
          echo "ğŸ³ Reconstruyendo contenedores..."
          # Bajamos primero para limpiar cualquier estado zombie
          docker compose down
          # Levantamos y construimos (-d en fondo, --build fuerza recrear imagenes)
          docker compose up -d --build
          
          # 4. Esperar un momento a que la DB arranque
          echo "â³ Esperando a que la base de datos estÃ© lista..."
          sleep 10
          
          # 5. Tareas de Mantenimiento de Django
          echo "ğŸ—„ï¸ Ejecutando migraciones..."
          # Ejecuta migrate dentro del contenedor 'web'
          docker compose exec -T web python manage.py migrate
          
          echo "ğŸ¨ Recolectando archivos estÃ¡ticos..."
          docker compose exec -T web python manage.py collectstatic --noinput
          
          # 6. Limpieza final (Opcional pero recomendado para no llenar el disco)
          echo "ğŸ§¹ Limpiando imÃ¡genes viejas de Docker..."
          docker system prune -f
          
          echo "âœ… Â¡Despliegue completado exitosamente!"