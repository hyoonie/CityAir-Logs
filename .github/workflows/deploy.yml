name: Deploy to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploying to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
    - name: Test SSH Connection
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "echo '¬°Conexi√≥n Exitosa!'"

    - name: Conectarse por SSH y Desplegar
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          cd /root/CityAirLogs_Infra/CityAir-Logs
          
          echo "üì• Sincronizando c√≥digo..."
          git fetch origin main
          git reset --hard origin/main
          
          echo "üöÄ Actualizando SOLO el contenedor WEB..."
          docker compose up -d --build --no-deps WEB

          docker compose restart nginx
          
          echo "‚è≥ Esperando a que Gunicorn arranque..."
          sleep 5
          
          echo "üóÑÔ∏è Mantenimiento Django..."
          docker compose exec -T web python manage.py makemigrations core
          docker compose exec -T web python manage.py migrate core
          docker compose exec -T web python manage.py migrate
          docker compose exec -T web python manage.py collectstatic --noinput
          
          docker system prune -f
          
          echo "‚úÖ Despliegue WEB completado (BDs y MQTT intactos)!"