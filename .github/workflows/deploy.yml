name: Deploy to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploying to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
    - name: Conectarse por SSH y Desplegar
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # CAMBIA ESTO POR TU RUTA REAL
          cd /root/CityAir-Logs
          
          echo "üì• Bajando c√≥digo nuevo..."
          git pull origin main
          
          echo "üê≥ Reconstruyendo contenedores..."
          docker compose up -d --build
          
          sleep 5
          
          echo "üóÑÔ∏è Mantenimiento Django..."
          docker compose exec -T web python manage.py makemigrations core
          docker compose exec -T web python manage.py migrate core
          docker compose exec -T web python manage.py migrate
          docker compose exec -T web python manage.py collectstatic --noinput
          
          docker system prune -f
          echo "‚úÖ Listo!"