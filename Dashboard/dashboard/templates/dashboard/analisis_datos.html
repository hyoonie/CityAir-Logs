{% extends "dashboard/base.html" %} {% load static %} {% block title %}Análisis
de Modelos · Calidad del Aire{% endblock %}

<!-- Aplicar CSS global para la paleta y la animación -->
<style>
  /* === ANIMACIÓN DE CARGA === */
  /* Estado inicial: El contenido empieza invisible */
  .initial-hidden {
    opacity: 0;
    transform: translateY(15px);
  }
  
  /* Transición CSS: Define cómo debe aparecer el contenido */
  .fade-in-active {
    transition: opacity 1s ease-out, transform 1s ease-out;
  }
  
  /* === PALETA DE COLORES Y ESTILOS BASE === */
  body {
    background-color: #ECEFCA; /* Fondo muy claro (Casi blanco) */
    color: #213448; /* Texto principal (Azul oscuro) */
    font-family: 'Inter', sans-serif;
  }
  .btn-primary {
    background-color: #547792; /* Botón principal: Azul medio */
    border-color: #547792;
    color: #FFFFFF; 
  }
  .btn-primary:hover {
    background-color: #43627a; 
    border-color: #43627a;
  }
  .nk-subtle, .text-muted {
    color: #547792 !important; /* Ajustar el color sutil/gris */
  }
  h1, h5, h2 {
    color: #213448;
    font-family: 'Inter', sans-serif;
  }
  .border-bottom {
    border-color: #94B4C1 !important; /* Separador de color gris claro */
  }
</style>

{% block content %}

<!-- ENCABEZADO CENTRAL Y TITULAR (Estilo coherente con el Home) -->
<header
  class="py-5 mb-5 border-bottom text-center"
  style="border-color: #f2ead3 !important"
>
  <div class="mx-auto" style="max-width: 800px">
    <span
      class="nk-subtle text-uppercase fw-semibold mb-2 d-block tracking-widest"
      style="font-family: 'Inter', sans-serif; color: #344f1f !important"
    >
      Resultados del Machine Learning
    </span>
    <h1
      class="display-3 fw-bolder mb-3"
      style="font-family: 'Inter', sans-serif; letter-spacing: -2px"
    >
      Análisis de Validación
    </h1>
    <p
      class="lead text-muted mx-auto"
      style="
        max-width: 600px;
        font-size: 1.25rem;
        font-family: 'Inter', sans-serif;
        color: #344f1f !important;
      "
    >
      Esta vista muestra la **gráfica de validación** y los indicadores clave
      (MAE, RMSE, R²) generados por la última ejecución del script de Regresión
      Lineal y Random Forest.
    </p>
    <div class="mt-4 d-flex justify-content-center gap-3">
      <a class="btn btn-primary btn-lg rounded-pill" href="{% url 'resumen' %}">
        Ver CSV de Predicciones
      </a>
      <a
        class="btn btn-outline-secondary btn-lg rounded-pill"
        href="{% url 'generador' %}"
        style="color: #344f1f; border-color: #344f1f"
      >
        Volver a Generar Modelos
      </a>
    </div>
  </div>
</header>

<!-- GRÁFICA DE PREDICCIÓN (Contenedor Dinámico) -->
<section class="mb-5">
  <h5 class="fw-bold mb-4 text-center">
    Gráfico de Predicción (Última Ejecución)
  </h5>
  <div id="model-output-container" class="mx-auto" style="max-width: 1000px">
    <!-- Contenido cargado por JavaScript -->
    <div
      class="text-center p-5 text-muted"
      id="loading-message"
      style="color: #344f1f !important"
    >
      Cargando datos del modelo...
    </div>
  </div>
</section>

<!-- MÉTRICAS CLAVE (Contenedores de KPIs Dinámicos) -->
<section class="mb-5">
  <h5 class="fw-bold mb-4 text-center" style="color: #344f1f">
    Métricas Clave: Random Forest (PM2.5)
  </h5>

  <div class="row g-4 justify-content-center" id="kpi-row">
    <!-- MAE -->
    <div class="col-12 col-md-4 col-lg-3">
      <div
        class="p-4 border rounded-lg text-center h-100 shadow-sm"
        style="background-color: #f9f5f0; border-color: #f2ead3"
      >
        <span
          class="nk-subtle d-block text-uppercase small fw-semibold"
          style="color: #547792 !important"
          >MAE (Error Absoluto Medio)</span
        >
        <div
          class="display-5 fw-light mt-2"
          id="kpi-mae"
          style="color: #344f1f; font-family: 'Inter', sans-serif"
        >
          N/A
        </div>
        <small class="text-muted" style="color: #344f1f !important"
          >Error en conjunto de prueba.</small
        >
      </div>
    </div>

    <!-- RMSE -->
    <div class="col-12 col-md-4 col-lg-3">
      <div
        class="p-4 border rounded-lg text-center h-100 shadow-sm"
        style="background-color: #f9f5f0; border-color: #f2ead3"
      >
        <span
          class="nk-subtle d-block text-uppercase small fw-semibold"
          style="color: #547792 !important"
          >RMSE (Raíz del Error Cuadrático Medio)</span
        >
        <div
          class="display-5 fw-light mt-2"
          id="kpi-rmse"
          style="color: #344f1f; font-family: 'Inter', sans-serif"
        >
          N/A
        </div>
        <small class="text-muted" style="color: #344f1f !important"
          >Desviación estándar de los errores.</small
        >
      </div>
    </div>

    <!-- R² -->
    <div class="col-12 col-md-4 col-lg-3">
      <div
        class="p-4 border rounded-lg text-center h-100 shadow-sm"
        style="background-color: #f9f5f0; border-color: #f2ead3"
      >
        <span
          class="nk-subtle d-block text-uppercase small fw-semibold"
          style="color: #547792 !important"
          >R² (Varianza Explicada)</span
        >
        <div
          class="display-5 fw-light mt-2"
          id="kpi-r2"
          style="color: #344f1f; font-family: 'Inter', sans-serif"
        >
          N/A
        </div>
        <small class="text-muted" style="color: #344f1f !important"
          >Capacidad predictiva del modelo.</small
        >
      </div>
    </div>
  </div>
</section>

<!-- CTA FINAL (Pie de página simple) -->
<section class="pt-4 pb-2 text-center">
  <small class="text-muted" style="color: #344f1f !important">
    La última ejecución del modelo generó estos resultados.
    <a
      href="{% url 'generador' %}"
      class="fw-semibold text-decoration-none ms-1"
      style="color: #547792"
      >Haz clic aquí para volver a entrenar.</a
    >
  </small>
</section>

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const kpiMae = document.getElementById("kpi-mae");
    const kpiRmse = document.getElementById("kpi-rmse");
    const kpiR2 = document.getElementById("kpi-r2");
    const container = document.getElementById("model-output-container");
    const apiUrl = "{% url 'kpis_api' %}";

    fetch(apiUrl)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Respuesta de red no fue ok");
        }
        return response.json();
      })
      .then((data) => {
        if (data.error_msg) {
          // Mostrar mensaje de error si el archivo no existe
          container.innerHTML = `
                    <div class="alert alert-warning text-center mx-auto" style="max-width: 600px; background-color: #F2EAD3; border-color: #547792; color: #344F1F;">
                        <strong>Atención:</strong> ${data.error_msg}
                    </div>
                `;
          // Mostrar N/A en KPIs
          kpiMae.textContent = "N/A";
          kpiRmse.textContent = "N/A";
          kpiR2.textContent = "N/A";
        } else {
          // 1. Actualizar KPIs
          kpiMae.innerHTML = `${data.MAE}<span class="fs-4 text-muted" style="color: #344F1F !important;"> µg/m³</span>`;
          kpiRmse.innerHTML = `${data.RMSE}<span class="fs-4 text-muted" style="color: #344F1F !important;"> µg/m³</span>`;
          kpiR2.textContent = data.R2;

          // 2. Insertar Gráfico (Imagen estática)
          const staticUrl = "{% static 'dashboard/' %}";
          container.innerHTML = `
                    <div class="card p-3 border" style="background-color: #F9F5F0; border-color: #F2EAD3;">
                        <img 
                            src="${staticUrl}${data.png_filename}" 
                            alt="Gráfica de predicción vs real" 
                            class="img-fluid rounded"
                            loading="lazy"
                        >
                    </div>
                    <small class="nk-subtle d-block mt-2" style="color: #344F1F;">Gráfico de valores reales vs. predichos por Random Forest.</small>
                `;
        }
      })
      .catch((error) => {
        console.error("Error al obtener datos:", error);
        container.innerHTML = `
                <div class="alert alert-danger">
                    Error de conexión al cargar el modelo. (Consola para más detalles)
                </div>
            `;
      });
  });
</script>
{% endblock extra_js %} {% endblock content %}
