{% extends 'base/base.html' %}
{% load static %}
{% block headmeta %}
  <link rel="stylesheet" href="{% static '/styles/analisis-predictivo/predicciones.css' %}">
{% endblock %}

{% block title %}Prediciones{{ block.super }}{% endblock %}
{% block content %}
  <!-- OVERLAY DE CARGA -->
  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="loading-box">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <h6 class="fw-bold mb-1">Generando predicci√≥n</h6>
      <p class="small text-muted mb-0">Estamos analizando los datos y calculando los escenarios futuros‚Ä¶</p>
    </div>
  </div>
  <div class="content initial-hidden py-5" id="main-content">
    <div class="container-fluid dashboard-container px-4">
      <h1 class="display-6 fw-bold text-center mb-1">
        Calidad del Aire - <span class="text-primary">An√°lisis Predictivo</span>
      </h1>
      <p class="text-muted text-center mb-5">
        Resultados basados en modelos de <strong>Machine Learning</strong>.
      </p>
      {% if not selected_device %}
        <div class="alert alert-warning text-center mt-4 shadow-sm">
          <i class="bi bi-exclamation-circle-fill me-2"></i>
          Por favor, <strong>selecciona un sensor</strong> en el filtro de abajo para cargar los datos.
        </div>
      {% endif %}
      <!-- ========================= FILTROS ========================== -->
      <div class="card-main mb-5">
        <div class="card-body">
          <form method="get" class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Sensor Dispositivo</label>
              <select name="device" class="form-select">
                <option value="">-- Seleccionar --</option>
                {% for d in devices %}
                  <option value="{{ d }}" {% if selected_device == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Fecha Inicio</label>
              <input type="date"
                     name="start_date"
                     class="form-control"
                     value="{{ request.GET.start_date }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Fecha Fin</label>
              <input type="date"
                     name="end_date"
                     class="form-control"
                     value="{{ request.GET.end_date }}" />
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-primary px-5">
                <i class="bi bi-cpu-fill me-2"></i> Generar an√°lisis predictivo
              </button>
            </div>
          </form>
        </div>
      </div>
      {% if selected_device %}
        <!-- ========================= KPIs ========================== -->
        <div class="kpi-row-wrapper mb-5">
          <div class="kpi-row">
            {% with mp=metrics_pm25 mc=metrics_co2 %}
              <!-- Registros PM2.5 -->
              <div class="col-md-3 col-sm-6">
                <div class="kpi-card text-center">
                  <i class="bi bi-cloud-haze2 fs-3 text-warning mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mp.n_samples|default:"0" }}</h4>
                  <span class="text-muted small">Registros PM2.5</span>
                </div>
              </div>
              <!-- Registros CO2 -->
              <div class="col-md-3 col-sm-6">
                <div class="kpi-card text-center">
                  <i class="bi bi-cloud-haze fs-3 text-success mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mc.n_samples|default:"0" }}</h4>
                  <span class="text-muted small">Registros CO‚ÇÇ</span>
                </div>
              </div>
              <!-- R2 PM2.5 -->
              <div class="col-md-2 col-sm-4">
                <div class="kpi-card text-center">
                  <i class="bi bi-graph-up fs-3 text-primary mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mp.R2|floatformat:2 }}</h4>
                  <span class="text-muted small">R¬≤ PM2.5</span>
                </div>
              </div>
              <!-- RMSE PM2.5 -->
              <div class="col-md-2 col-sm-4">
                <div class="kpi-card text-center">
                  <i class="bi bi-exclamation-triangle fs-3 text-danger mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mp.RMSE|floatformat:2 }}</h4>
                  <span class="text-muted small">RMSE PM2.5</span>
                </div>
              </div>
              <!-- MAE PM2.5 -->
              <div class="col-md-2 col-sm-4">
                <div class="kpi-card text-center">
                  <i class="bi bi-bar-chart fs-3 text-secondary mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mp.MAE|floatformat:2 }}</h4>
                  <span class="text-muted small">MAE PM2.5</span>
                </div>
              </div>
              <!-- R2 CO2 -->
              <div class="col-md-2 col-sm-4">
                <div class="kpi-card text-center">
                  <i class="bi bi-graph-up fs-3 text-primary mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mc.R2|floatformat:2 }}</h4>
                  <span class="text-muted small">R¬≤ CO‚ÇÇ</span>
                </div>
              </div>
              <!-- RMSE CO2 -->
              <div class="col-md-2 col-sm-4">
                <div class="kpi-card text-center">
                  <i class="bi bi-exclamation-triangle fs-3 text-danger mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mc.RMSE|floatformat:2 }}</h4>
                  <span class="text-muted small">RMSE CO‚ÇÇ</span>
                </div>
              </div>
              <!-- MAE CO2 -->
              <div class="col-md-2 col-sm-4">
                <div class="kpi-card text-center">
                  <i class="bi bi-bar-chart fs-3 text-secondary mb-2"></i>
                  <h4 class="fw-bold mb-0">{{ mc.MAE|floatformat:2 }}</h4>
                  <span class="text-muted small">MAE CO‚ÇÇ</span>
                </div>
              </div>
            {% endwith %}
          </div>
        </div>
        <!-- ========================= SEM√ÅFORO DE CALIDAD DEL AIRE ========================== -->
        {% if resumen_ejecutivo %}
          <div class="semaforo-card-container mb-5">
            <div class="semaforo-card">
              <div class="semaforo-status">
                <span class="semaforo-indicator {% if resumen_ejecutivo.nivel == 'BUENO' %}indicator-green{% endif %} {% if resumen_ejecutivo.nivel == 'ACEPTABLE' %}indicator-yellow{% endif %} {% if resumen_ejecutivo.nivel == 'MALO' or resumen_ejecutivo.nivel == 'MUY MALO' %}indicator-red{% endif %} "></span>
                <div>
                  <div class="fw-bold">{{ resumen_ejecutivo.nivel }}</div>
                  <div class="semaforo-recomendacion">{{ resumen_ejecutivo.mensaje }}</div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
        <!-- ========================= PREDICCI√ìN A CORTO PLAZO ========================== -->
        <div class="section-block">
          <div class="section-header">
            <div class="section-title">
              <i class="bi bi-lightning-charge-fill"></i>
              Predicci√≥n a corto plazo (48 horas)
            </div>
          </div>
          <p class="text-muted small mb-3">
            Estimaci√≥n del comportamiento esperado de los contaminantes durante las pr√≥ximas
            <strong>48 horas</strong>, basada en patrones hist√≥ricos y condiciones ambientales recientes.
          </p>
          <div class="section-grid">
            <!-- PM2.5 -->
            {% if txt_pm25 %}
              <div class="section-card">
                <h6 class="fw-bold text-primary mb-2">
                  <i class="bi bi-cloud-haze2 me-2"></i>
                  PM2.5
                </h6>
                <p class="small mb-2">{{ txt_pm25.mensaje|safe }}</p>
                <p class="small text-muted mb-0">
                  <strong>Promedio estimado:</strong> {{ txt_pm25.mean_pred }} ¬µg/m¬≥
                  <br>
                  <strong>Pico m√°ximo esperado:</strong> {{ txt_pm25.max_pred }} ¬µg/m¬≥
                </p>
              </div>
            {% endif %}
            <!-- CO2 -->
            {% if txt_co2 %}
              <div class="section-card section-card-light">
                <h6 class="fw-bold text-primary mb-2">
                  <i class="bi bi-cloud-haze me-2"></i>
                  CO‚ÇÇ
                </h6>
                <p class="small mb-2">{{ txt_co2.mensaje|safe }}</p>
                <p class="small text-muted mb-0">
                  <strong>Promedio estimado:</strong> {{ txt_co2.mean_pred }} ppm
                  <br>
                  <strong>Pico m√°ximo esperado:</strong> {{ txt_co2.max_pred }} ppm
                </p>
              </div>
            {% endif %}
          </div>
          <div class="section-footer">
            * Predicci√≥n generada autom√°ticamente mediante modelos de aprendizaje autom√°tico y t√©cnicas de persistencia temporal.
          </div>
        </div>
        <!-- ========================= CONTEXTO AMBIENTAL ========================== -->
        {% if stats_ambientales %}
          <div class="section-block">
            <div class="section-header">
              <div class="section-title">
                <i class="bi bi-thermometer-sun"></i>
                Contexto Ambiental Promedio
              </div>
            </div>
            <div class="section-grid text-center">
              {% if stats_ambientales.temp %}
                <div class="section-card">
                  <h6 class="text-muted text-uppercase small fw-bold">Temperatura (¬∞C)</h6>
                  <span class="display-6 fw-bold text-dark">{{ stats_ambientales.temp }}</span>
                </div>
              {% endif %}
              {% if stats_ambientales.humidity %}
                <div class="section-card">
                  <h6 class="text-muted text-uppercase small fw-bold">Humedad (%)</h6>
                  <span class="display-6 fw-bold text-dark">{{ stats_ambientales.humidity }}</span>
                </div>
              {% endif %}
              {% if stats_ambientales.pressure %}
                <div class="section-card">
                  <h6 class="text-muted text-uppercase small fw-bold">Presi√≥n (hPa)</h6>
                  <span class="display-6 fw-bold text-dark">{{ stats_ambientales.pressure }}</span>
                </div>
              {% endif %}
              {% if stats_ambientales.light %}
                <div class="section-card section-card-light">
                  <h6 class="text-muted text-uppercase small fw-bold">Luz (lux)</h6>
                  <span class="display-6 fw-bold text-dark">{{ stats_ambientales.light }}</span>
                </div>
              {% endif %}
            </div>
            <div class="section-footer">* Valores promedio calculados sobre el rango de fechas seleccionado.</div>
          </div>
        {% endif %}
        <!-- ========================= RESUMEN EJECUTIVO ========================== -->
        {% if resumen_ejecutivo %}
          <div class="section-block">
            <div class="section-header">
              <div class="section-title">
                <i class="bi bi-clipboard-data"></i>
                Resumen Ejecutivo
              </div>
              {% if resumen_ejecutivo.nivel == "BUENO" %}
                <span class="badge rounded-pill bg-success px-3 py-2">BUENO</span>
              {% elif resumen_ejecutivo.nivel == "ACEPTABLE" %}
                <span class="badge bg-warning text-dark">ACEPTABLE</span>
              {% elif resumen_ejecutivo.nivel == "MALO" %}
                <span class="badge bg-danger">MALO</span>
              {% else %}
                <span class="badge bg-danger">MUY MALO</span>
              {% endif %}
            </div>
            <div class="section-grid">
              {% for sec in resumen_ejecutivo.sections %}<div class="section-card">{{ sec|safe }}</div>{% endfor %}
            </div>
            <div class="section-footer">{{ resumen_ejecutivo.footer }}</div>
          </div>
        {% endif %}
        <!-- ========================= GR√ÅFICAS ========================== -->
        <div class="row g-4 mb-5">
          <!-- PM2.5 -->
          <div class="col-xl-6 col-lg-12">
            <div class="card-main h-100">
              <div class="card-body">
                <h5 class="card-title text-center fw-bold mb-3">Predicci√≥n PM2.5</h5>
                <div class="grafica-container p-2 bg-light rounded">{{ grafica_pm25|safe }}</div>
              </div>
            </div>
          </div>
          <!-- CO2 -->
          <div class="col-xl-6 col-lg-12">
            <div class="card-main h-100">
              <div class="card-body">
                <h5 class="card-title text-center fw-bold mb-3">Predicci√≥n CO‚ÇÇ</h5>
                <div class="grafica-container p-2 bg-light rounded">{{ grafica_co2|safe }}</div>
              </div>
            </div>
          </div>
        </div>
        <!-- ========================= AYUDA ========================== -->
        <div class="section-block">
          <div class="section-header">
            <div class="section-title">
              <i class="bi bi-question-circle-fill"></i>
              ¬øC√≥mo interpretar estos resultados?
            </div>
          </div>
          <p class="text-muted small mb-3">
            Estas m√©tricas ayudan a entender qu√© tan confiables son las predicciones del modelo.
          </p>
          <div class="section-grid">
            <div class="section-card">
              <h6 class="fw-bold text-success">üìä Coeficiente de determinaci√≥n (R¬≤)</h6>
              <p class="mb-0">
                Mide qu√© tan bien el modelo explica los datos reales.
                Valores cercanos a <strong>1.0</strong> indican alta precisi√≥n.
              </p>
            </div>
            <div class="section-card">
              <h6 class="fw-bold text-danger">üìâ Error cuadr√°tico medio (RMSE)</h6>
              <p class="mb-0">
                Indica el tama√±o promedio del error.
                Mientras m√°s bajo, m√°s confiables son las predicciones.
              </p>
            </div>
            <div class="section-card">
              <h6 class="fw-bold text-warning">üìè Error absoluto medio (MAE)</h6>
              <p class="mb-0">Muestra el error promedio real del modelo, sin exagerar valores extremos.</p>
            </div>
            <div class="section-card section-card-light">
              <h6 class="fw-bold text-primary">ü§ñ Modelo de Inteligencia Artificial (Random Forest)</h6>
              <p class="mb-0">
                Combina m√∫ltiples modelos de decisi√≥n para detectar patrones complejos
                y ofrecer predicciones m√°s estables y confiables.
              </p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const content = document.getElementById("main-content");
        if (content) content.classList.remove("initial-hidden");

        const form = document.querySelector("form");
        const overlay = document.getElementById("loading-overlay");

        if (form && overlay) {
          form.addEventListener("submit", function () {
            overlay.classList.remove("d-none");
          });
        }
      });
    </script>
  </div>
</div>
{% endblock content %}
