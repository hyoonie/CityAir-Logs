{% extends 'base/base.html' %}
{% load static %}
{% block content %}
<div class="content">
    <h2 class="mb-4 text-center" id="device-title">Dispositivo: Sensor 1</h2>
    <div class="mb-4 text-center">
        <label for="device-selector" class="form-label">Seleccionar dispositivo:</label>
        <select class="form-select w-auto d-inline-block" id="device-selector">
            <option value="1" selected>Sensor 1</option>
            <option value="2">Sensor 2</option>
        </select>
    </div>
    <div class="main-grid">
        <div id="map"></div>
        <div>
            <div class="data-cards-container">
                <div class="data-card"><h5>PM2.5</h5><p id="pm25-value">15 µg/m³</p></div>
                <div class="data-card"><h5>PM10</h5><p id="pm10-value">30 µg/m³</p></div>
                <div class="data-card"><h5>CO₂</h5><p id="co2-value">420 ppm</p></div>
                <div class="data-card"><h5>Temperatura</h5><p id="temp-value">24 °C</p></div>
                <div class="data-card"><h5>Humedad</h5><p id="hum-value">65 %</p></div>
                <div class="data-card"><h5>Luz</h5><p id="luz-value">120 lx</p></div>
            </div>
            <div class="semaforo-card-container">
                <div class="semaforo-card">
                    <div class="semaforo-status">
                        <span class="semaforo-indicator indicator-green" id="semaforo-indicator"></span>
                        <div class="text-start">
                            <p class="m-0 text-dark" id="semaforo-status-text">Calidad del Aire: <strong>BUENA</strong></p>
                            <p class="m-0 semaforo-recomendacion" id="semaforo-recommendation">
                                Recomendación: ¡Disfruta de las actividades al aire libre!
                            </p>
                        </div>
                    </div>
                    <div class="text-end">
                        <p class="m-0 text-secondary">PM2.5 Actual</p>
                        <p class="m-0 text-dark" style="font-size: 1.5rem;" id="semaforo-pm25-value">15 µg/m³</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="filters mt-4">
         <select class="form-select"><option selected>Variable</option></select>
         <select class="form-select"><option selected>Rango de tiempo</option></select>
    </div>
    <div class="chart-container mb-5">
        <canvas id="chartExample"></canvas>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- Datos de los Sensores ---
    const sensorData = {
        "1": { // Datos Sensor 1 (Medellín - Verde)
            title: "Dispositivo: Sensor 1",
            lat: 6.24,    // <-- Coordenadas Medellín
            lng: -75.58,  // <-- Coordenadas Medellín
            popupText: "Sensor 1 - Medellín", // <-- Texto del popup
            pm25: "15 µg/m³", pm10: "30 µg/m³", co2: "420 ppm", temp: "24 °C", hum: "65 %", luz: "120 lx", semaforoClass: "indicator-green", semaforoStatus: "Calidad del Aire: <strong>BUENA</strong>", semaforoRecommendation: "Recomendación: ¡Disfruta de las actividades al aire libre!"
        },
        "2": { // Datos Sensor 2 (Xalapa - Rojo)
            title: "Dispositivo: Sensor 2",
            lat: 19.54,   // <-- Coordenadas Xalapa
            lng: -96.91,   // <-- Coordenadas Xalapa
            popupText: "Sensor 2 - Xalapa", // <-- Texto del popup
            pm25: "160 µg/m³", pm10: "250 µg/m³", co2: "1500 ppm", temp: "28 °C", hum: "70 %", luz: "50 lx", semaforoClass: "indicator-red", semaforoStatus: "Calidad del Aire: <strong>MUY MALA</strong>", semaforoRecommendation: "Recomendación: Evita actividades al aire libre. Grupos sensibles deben permanecer en interiores."
        }
    };
    // --- Elementos del DOM ---
    const deviceSelector = document.getElementById('device-selector');
    const deviceTitle = document.getElementById('device-title');
    const pm25Value = document.getElementById('pm25-value');
    const pm10Value = document.getElementById('pm10-value');
    const co2Value = document.getElementById('co2-value');
    const tempValue = document.getElementById('temp-value');
    const humValue = document.getElementById('hum-value');
    const luzValue = document.getElementById('luz-value');
    const semaforoIndicator = document.getElementById('semaforo-indicator');
    const semaforoStatusText = document.getElementById('semaforo-status-text');
    const semaforoRecommendation = document.getElementById('semaforo-recommendation');
    const semaforoPm25Value = document.getElementById('semaforo-pm25-value');
    // --- Inicializar Mapa ---
    const initialData = sensorData["1"]; // Inicia con Sensor 1 (Medellín)
    const map = L.map('map').setView([initialData.lat, initialData.lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
    let mapMarker = L.marker([initialData.lat, initialData.lng]).addTo(map).bindPopup(initialData.popupText);
    // --- Función para Actualizar Datos ---
    function updateDisplay(sensorId) {
        const data = sensorData[sensorId];
        if (!data) return;
        // Actualizar textos y semáforo
        deviceTitle.textContent = data.title;
        pm25Value.textContent = data.pm25;
        pm10Value.textContent = data.pm10;
        co2Value.textContent = data.co2;
        tempValue.textContent = data.temp;
        humValue.textContent = data.hum;
        luzValue.textContent = data.luz;
        semaforoIndicator.className = `semaforo-indicator ${data.semaforoClass}`;
        semaforoStatusText.innerHTML = data.semaforoStatus;
        semaforoRecommendation.textContent = data.semaforoRecommendation;
        semaforoPm25Value.textContent = data.pm25;
        // --- ACTUALIZAR MAPA ---
        const newLatLng = [data.lat, data.lng];
        map.setView(newLatLng, 13);
        mapMarker.setLatLng(newLatLng);
        mapMarker.bindPopup(data.popupText).openPopup();
        // --- FIN ACTUALIZAR MAPA ---
        // (Actualizar gráfica aquí si es necesario)
    }
    // --- Event Listener ---
    deviceSelector.addEventListener('change', function() {
        updateDisplay(this.value);
    });
    // --- Inicializar Gráfica ---
    const ctx = document.getElementById('chartExample').getContext('2d');
    const myChart = new Chart(ctx, { /* ... tu config de Chart.js ... */ });
    // (Opcional) Llamar a updateDisplay al cargar la página
    // updateDisplay(deviceSelector.value);
</script>
{% endblock %}