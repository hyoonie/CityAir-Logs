{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dispositivos en Tiempo Real{{ block.super }}{% endblock %}

{% block headmeta %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="{% static 'styles/dispositivos.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark m-0" id="device-title">Mapa General</h2>
        <div>
            <select class="form-select form-select-lg shadow-sm border-0" id="device-selector" style="min-width: 250px;">
                <option value="" selected>Elegir dispositivo</option>
                {% for dev in dispositivos_list %}
                    <option value="{{ dev.idDispositivo }}">
                        {{ dev.idDispositivo }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row g-4"> <div class="col-lg-8 col-12">
            <div id="map"></div>
            <p class="text-muted small mt-2 text-end" id="address-display">
                <i class="bi bi-map"></i> Mostrando todos los dispositivos activos.
            </p>
        </div>

        <div class="col-lg-4 col-12">
            <div id="data-panel" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
                
                <div class="semaforo-card mb-4" id="semaforo-card">
                    <div class="d-flex align-items-center">
                        <span class="semaforo-indicator status-good" id="semaforo-indicator"></span>
                        <div>
                            <h5 class="text-muted mb-1">Calidad del Aire</h5>
                            <h3 class="fw-bold m-0" id="semaforo-status-text">--</h3>
                        </div>
                    </div>
                    <div class="text-end" style="max-width: 50%;">
                        <p class="small text-muted mb-1" id="semaforo-recommendation">...</p>
                    </div>
                </div>

                <div class="data-cards-container">
                    <div class="data-card"><h5>PM2.5</h5><p><span id="val-pm25">--</span> <small class="text-muted fs-6">µg/m³</small></p></div>
                    <div class="data-card"><h5>PM10</h5><p><span id="val-pm10">--</span> <small class="text-muted fs-6">µg/m³</small></p></div>
                    <div class="data-card"><h5>Temp</h5><p><span id="val-temp">--</span> <small class="text-muted fs-6">°C</small></p></div>
                    <div class="data-card"><h5>Humedad</h5><p><span id="val-hum">--</span> <small class="text-muted fs-6">%</small></p></div>
                </div>
                
            </div>
        </div>
    </div> </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Datos desde Django
    const devicesData = {{ map_data_json|safe }}; 

    // Referencias DOM
    const selector = document.getElementById('device-selector');
    const panel = document.getElementById('data-panel');
    const title = document.getElementById('device-title'); // Este es el H2
    const addressDisp = document.getElementById('address-display');
    const ui = {
        pm25: document.getElementById('val-pm25'),
        pm10: document.getElementById('val-pm10'),
        temp: document.getElementById('val-temp'),
        hum: document.getElementById('val-hum'),
        semInd: document.getElementById('semaforo-indicator'),
        semCard: document.getElementById('semaforo-card'),
        semText: document.getElementById('semaforo-status-text'),
        semRec: document.getElementById('semaforo-recommendation')
    };

    const map = L.map('map').setView([19.5438, -96.9102], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let markers = {}; 
    const allMarkersGroup = L.featureGroup();

    for (const [id, data] of Object.entries(devicesData)) {
        const marker = L.marker([data.lat, data.lng]).addTo(map);
        marker.bindPopup(`<b>${data.title}</b><br>PM2.5: ${data.pm25}`);
        
        marker.on('click', function() {
            // SOLUCION 2 (Parte A): Aseguramos que el ID sea string al asignar al selector
            selector.value = String(id); 
            updateDisplay(id);
        });

        markers[id] = marker;
        allMarkersGroup.addLayer(marker);
    }

    if (Object.keys(markers).length > 0) {
        map.fitBounds(allMarkersGroup.getBounds().pad(0.1));
    }

    // --- FUNCIÓN UPDATE ---
    function updateDisplay(devId) {
        // SOLUCION 2 (Parte B): Forzamos conversión a String para evitar error de tipos
        devId = String(devId);
        const data = devicesData[devId];
        
        if (!devId || !data) {
            resetView();
            return;
        }

        panel.style.opacity = "1";
        panel.style.pointerEvents = "all";

        // SOLUCION 1: ELIMINADA la línea que cambiaba el título H2
        // title.innerText = data.title;  <--- ESTA LINEA SE BORRÓ
        
        addressDisp.innerHTML = `<i class="bi bi-geo-alt-fill text-danger"></i> ${data.address}`;
        ui.pm25.innerText = data.pm25;
        ui.pm10.innerText = data.pm10;
        ui.temp.innerText = data.temp;
        ui.hum.innerText = data.hum;

        ui.semInd.className = `semaforo-indicator ${data.sem_color}`;
        ui.semCard.className = `semaforo-card mb-4 ${data.sem_border}`;
        ui.semText.innerText = data.sem_status;
        ui.semRec.innerText = data.sem_rec;

        // Mover mapa
        const targetMarker = markers[devId];
        if (targetMarker) {
            map.setView(targetMarker.getLatLng(), 15);
            targetMarker.openPopup();
        }
    }

    function resetView() {
        panel.style.opacity = "0.5";
        panel.style.pointerEvents = "none";
        
        // title.innerText = "Mapa General"; // TAMBIEN BORRAMOS ESTO para no tocar el H2
        addressDisp.innerHTML = '<i class="bi bi-map"></i> Mostrando todos los dispositivos activos.';
        
        map.closePopup();
        if (Object.keys(markers).length > 0) {
            map.fitBounds(allMarkersGroup.getBounds().pad(0.1));
        }
    }

    // Listener del Dropdown
    selector.addEventListener('change', function() {
        console.log("Seleccionado:", this.value); // Debug para ver si entra al evento
        updateDisplay(this.value);
    });
</script>
{% endblock %}